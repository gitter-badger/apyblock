#!/bin/bash
#
# A Shell Blocker
# Block annoying ADs with a single script.
#
# Copyright (C) 2016 Federico Dami√°n Schonborn <federicodamians@gmail.com>
#
# This file is part of A Shell Blocker.
#
# A Shell Blocker is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 2 of the License, or
# (at your option) any later version.
#
# A Shell Blocker is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with A Shell Blocker. If not, see <http://www.gnu.org/licenses/>.

# Configurations:

# Set the webpage for downloading the /etc/hosts file:
file_source="http://hosts-file.net/download/hosts.txt"

# Configurations end.

# Functions:

# Check if local configuration file exists:
check_localconf() {
  if [[ -f ~/.config/ashblock/source.conf ]]; then
    rm ~/.config/ashblock/source.conf
  else
    if [[ ! -d ~/.config/ashblock ]]; then
      mkdir -pv ~/.config/ashblock
    fi
    touch ~/.config/ashblock/source.conf
  fi
}

# If exists, load local configuration file:
load_localconf() {
  if [[ -f ~/.config/ashblock/source.conf ]]; then
    echo -e "Using local configuration file"
    source ~/.config/ashblock/source.conf
  fi
}

# Back-up the original hosts file:
backup_hosts() {
  if [[ -f /etc/hosts ]]; then
    sudo mv /etc/hosts /etc/hosts.bak
  fi
}

# Functions end.

# Start of case:
case ${1} in
  about|-a)
    echo -e "\n> A Shell Blocker (ashblock)"
    echo -e "> Block annoying ADs with a simple script."
    echo -e "> Version: 3.0 \"Cygnus\" (master)"
    echo -e "> Homepage: https://feskyde.github.io/ashblock"
    echo -e "> License: GPLv2\n"
    ;;
  help|?)
    echo -e "\n> Usage: ashblock\n"
    echo -e "Options:"
    echo -e "-a | about           About A Shell Blocker."
    echo -e " ? | help            This prompt!\n"
    echo -e "Source:"
    echo -e "-s | source          Change the hosts file source (locally).\n"
    echo -e "Local hosts file:"
    echo -e "-r | restore         Restore the default hosts file (if you deleted it).\n"
    echo -e "Cron job:"
    echo -e "-c | cron            Enable/disable Cron Job\n"
    ;;
  source|-s)
    if [[ $2 == * ]]; then
      check_localconf
      echo -e "file_source=\"${2}\"" > ~/.config/ashblock/source.conf
    elif [[ $2 == "default" ]]; then
      check_localconf
      rm -rf ~/.config/ashblock
    else
      echo -e "\n> A Shell Blocker (ashblock) -- Source File changer"
      echo -e "\n> Usage: ashblock source https://anyweb.com/hosts"
      echo -e "  or:    ashblock source default\n"
    fi
    ;;
  restore|-r)
    if [[ -f /etc/hosts.bak ]]; then
      sudo rm -rfv /etc/hosts
      sudo mv -v /etc/hosts.bak /etc/hosts
    else
      echo -e "ERROR: Backup file is not found!"
      exit 1
    fi
    ;;
  cron|-c)
    if [[ $2 == --enable ]]; then
      if [[ -x /usr/share/ashblock/ashblock.cron ]]; then
        sudo mv /usr/share/ashblock/ashblock.cron /etc/cron.daily/ashblock.cron
      else
        echo -e "ERROR: Cron job is not found!"
        exit 1
      fi
    elif [[ $2 == --disable ]]; then
      if [[ -x /etc/cron.daily/ashblock.cron ]]; then
        sudo mv /etc/cron.daily/ashblock.cron /usr/share/ashblock/ashblock.cron
      else
        echo -e "ERROR: Cron job is not found!"
        exit 1
      fi
    else
      echo -e "\n> A Shell Blocker (ashblock) -- Cron Job switcher"
      echo -e "\n> Usage: ashblock cron [--enable|--disable]\n"
    fi
    ;;
  "")
    load_localconf
    backup_hosts
    sudo curl "$file_source" -o /etc/hosts
    ;;
esac
# End of case.

# Script end.
